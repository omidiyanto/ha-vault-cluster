---
- name: Check if Vault container is running
  shell: docker ps --filter "name=vault" --filter "status=running" -q
  register: vault_container_check
  changed_when: false

- name: Create Directories
  file:
    path: "{{ vault_base_dir }}/{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - config
    - data

- name: Template Vault Config (HCL)
  template:
    src: vault.hcl.j2
    dest: "{{ vault_base_dir }}/config/vault.hcl"
  register: vault_config_status

- name: Template Docker Compose
  template:
    src: docker-compose.yml.j2
    dest: "{{ vault_base_dir }}/docker-compose.yml"
  register: compose_config_status

- name: Ensure Container Up (Deploy/Recreate)
  shell: docker compose up -d
  args:
    chdir: "{{ vault_base_dir }}"
  when: >
    vault_container_check.stdout == "" or
    vault_config_status.changed or
    compose_config_status.changed

- name: Show Skip Message
  debug:
    msg: "Vault is already running and config matches. Skipping deployment."
  when: >
    vault_container_check.stdout != "" and
    not vault_config_status.changed and
    not compose_config_status.changed