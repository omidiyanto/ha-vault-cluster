---
- name: Rolling Restart Load Balancers
  hosts: loadbalancers
  become: true
  serial: 1 
  tasks:
    - name: Validate HAProxy Configuration
      command: haproxy -c -f /etc/haproxy/haproxy.cfg
      register: config_check
      changed_when: false

    - name: Restart HAProxy
      service:
        name: haproxy
        state: restarted
      when: config_check.rc == 0

    - name: Restart Keepalived
      service:
        name: keepalived
        state: restarted

    - name: Wait for HAProxy Port (443)
      wait_for:
        port: 443
        delay: 2
        timeout: 30

    - name: Check Service Status
      command: systemctl is-active {{ item }}
      loop:
        - haproxy
        - keepalived
      register: service_status
      changed_when: false
      failed_when: "'active' not in service_status.stdout"

    - name: Debug Info
      debug:
        msg: "Node {{ inventory_hostname }} restarted successfully."

  post_tasks:
    - name: Final VIP Check (On Master Node Only)
      shell: "ip addr show {{ vip_interface }} | grep {{ vip_address }}"
      register: vip_check
      changed_when: false
      failed_when: vip_check.rc != 0
      when: 
        - inventory_hostname == groups['loadbalancers'][0] 
        - keepalived_state == 'MASTER'
      ignore_errors: true
      tags: check_vip